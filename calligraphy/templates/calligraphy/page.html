{% extends parent_template|default:"ewucal/base.html" %}

{% block content %}
  {% load staticfiles %}
  <style>
  .page_container {
    margin-bottom: 1em;
}

.page_viewport {
  position: relative;
  overflow: hidden;
  border:1px solid #ccc;
  width:640px;
  height:480px;
  border: dashed 5px #999;
}

.page_viewport img

.page_zoom_slider_label {
    margin-top: .5em;
}
.char_box {
  border: 2px solid #40ff18;
}

.char_box_hover {
  border: 2px solid #63a0ff;
}

.char_box_select {
  border: 2px solid #ff5b60;
}

#defaultKitten {
    width: 560px; }

  </style>

  <div class="pane">
    <img src="{% static page.get_image %}" >
  </div>


    <div id="defaultKitten" class="carrotCell">
    <div class = "carrotCellView">
          <ol>
            <li>
            <span>321</span>
              <img src="/media/chars/06100007/00000089(572%2C201%2C617%2C280).jpg" />
            </li>

            <li>
            <span>323</span>
              <img src="/media/chars/06100007/00000089(584%2C738%2C637%2C795).jpg" />
            </li>

            <li>
            <span>4990</span>
              <img src="/media/chars/06100007/00000097(403%2C795%2C428%2C820).jpg" />
            </li>

            <li>
            <span>5002</span>
              <img src="/media/chars/06100007/00000111(66%2C134%2C95%2C154).jpg" />
            </li>

            <li>
            <span>5010</span>
              <img src="/media/chars/06100007/00000111(164%2C389%2C199%2C414).jpg" />
            </li>

            <li>
            <span>5020</span>
              <img src="/media/chars/06100007/00000111(265%2C322%2C297%2C344).jpg" />
            </li>

            <li>
            <span>5028</span>
              <img src="/media/chars/06100007/00000111(311%2C370%2C347%2C395).jpg" />
            </li>

            <li>
            <span>5039</span>
              <img src="/media/chars/06100007/00000111(410%2C277%2C442%2C299).jpg" />
            </li>

            <li>
            <span>5041</span>
              <img src="/media/chars/06100007/00000111(413%2C390%2C446%2C413).jpg" />
            </li>

            <li>
            <span>5046</span>
              <img src="/media/chars/06100007/00000111(509%2C469%2C542%2C491).jpg" />
            </li>

            <li>
            <span>5055</span>
              <img src="/media/chars/06100007/00000112(640%2C134%2C678%2C158).jpg" />
            </li>

            <li>
            <span>5058</span>
              <img src="/media/chars/06100007/00000112(644%2C385%2C678%2C411).jpg" />
            </li>

            <li>
            <span>5069</span>
              <img src="/media/chars/06100007/00000113(609%2C239%2C640%2C261).jpg" />
            </li>

            <li>
            <span>5071</span>
              <img src="/media/chars/06100007/00000113(657%2C261%2C690%2C288).jpg" />
            </li>
          </ol>
    </div>
    <div class="prev">prev</div>
    <div class="next">next</div> 
    </div>




  <script type="text/javascript">


    function iWindow ( $ ) {

        window.carrotDemos = window.carrotDemos || {};
        carrotDemos.setup = function() {
            $("#defaultKitten").carrotCell();
        }
        carrotDemos.setup();





      var settings = {
        'longset_side': 500,
        'zoom_max': 20, // 100X initial zoom
      }

      var src_image_length = {{ page.image_length }}
      var src_image_width = {{ page.image_width }}

      var $image = $('.pane img').extend({
        'start_width': null,
        'min_width': null,
        'max_width': null,
        'lw_ratio': null,
        'scale_factor': null,
        'zoom_factor': null,
        'offset_top': null,
        'offset_left': null,
        'middle_x': null,
        'middle_y': null
      })

      if (src_image_length > src_image_width) {
        $image.min_width = src_image_width * settings.longset_side / src_image_length
      }
      else {
        $image.min_width = settings.longset_side
      }
      $image.start_width = src_image_width
      $image.max_width = $image.min_width * settings.zoom_max
      $image.lw_ratio = src_image_length / src_image_width
      $image.scale_factor = $image.min_width / $image.start_width
      $image.offset_left = 0
      $image.offset_top = 0

      $image.width($image.min_width).height($image.min_width * $image.lw_ratio)
      $image.css({'left': 0, 'top': 0});
      $image.css('position', 'absolute').wrap('<div class="page_container"><div class="page_viewport"></div></div>');

      var $viewport = $image.parent().resizable()
      $viewport.extend({
        'middle_x': Math.round($viewport.width() / 2),
        'middle_y': Math.round($viewport.height() / 2),
        'last_selected': null
      })
      var $container = $viewport.parent();
      var boxes = new Set()

      function updateBoxPosition($box) {
        $box.css({
          'left': Math.round($image.scale_factor * ($box.x_top + $image.offset_left) + $viewport.middle_x),
          'top': Math.round($image.scale_factor * ($box.y_top + $image.offset_top) + $viewport.middle_y),
          'width': Math.round($image.scale_factor * $box.x_len),
          'height': Math.round($image.scale_factor * $box.y_len)
        })
      }

      function updateBoxes() {
        for (let $box of boxes) updateBoxPosition($box);

      }

      var $zoom_widget = $('<div class="jrac_zoom_slider"><div class="ui-slider-handle"></div></div>')
          .slider({
            value: $image.longest_side,
            min: $image.min_width,
            max: $image.max_width,
            slide: function (event, ui) {
              $image.width(ui.value).height(Math.round(ui.value * $image.lw_ratio))
              $image.scale_factor = ui.value / $image.start_width
              $image.css({
                'left': Math.round($image.offset_left * $image.scale_factor + $viewport.middle_x),
                'top': Math.round($image.offset_top * $image.scale_factor + $viewport.middle_y)
              });
              updateBoxes()
            }
          });
      $container.append($zoom_widget);

      $image.draggable({
        drag: function (event, ui) {
          $viewport.middle_x = Math.round($viewport.width() / 2)
          $viewport.middle_y = Math.round($viewport.height() / 2)
          $image.offset_left = (ui.position.left - $viewport.middle_x) / $image.scale_factor
          $image.offset_top = (ui.position.top - $viewport.middle_y) / $image.scale_factor
          updateBoxes()
        },
        scroll: false,
        addClasses: false
      })

      function buildABox(x1, y1, x2, y2) {
        var zoom_factor = $image.start_width / 694
        var $charBox = $('<div class="char_box"></div>')
            .css({
              'left': x1 * zoom_factor,
              'top': y1 * zoom_factor,
              'width':  (x2 - x1)  * zoom_factor,
              'height': (y2 - y1) * zoom_factor,
              'position': 'absolute'
            }).selectable({
              autoRefresh: false,
              stop: function( event, ui ) {
                $(this).toggleClass('char_box_select')
                if($viewport.last_selected) {
                    $viewport.last_selected.removeClass('ui-selected')
                    $viewport.last_selected.toggleClass('char_box_select')
                    $viewport.last_selected = $(this)
                    //rel_char.reloadWith('<li><span>1</span><img src="/media/chars/06100007/00000053(102%2C613%2C164%2C662).jpg" /></li>')
                    var rel_char = $(relChar).data("carrotCell")
                    rel_char.empty()
                }
                $viewport.last_selected = $(this)
              }
            }).extend({
              'x_top': x1 * zoom_factor,
              'y_top': y1 * zoom_factor,
              'x_len': (x2 - x1) * zoom_factor,
              'y_len': (y2 - y1) * zoom_factor,
              'x_top_initial': x1,
              'y_top_initial': y1,
              'x_len_initial': x2 -x1,
              'y_len_initial': y2 - y1,
              'related_chars': null,
              'selected': false
            }).hover(function(){
              if(!$(this).hasClass('ui-selected')) {
                $(this).toggleClass('char_box_hover')
              }}
              )
        return $charBox;
      }

     function x_scale_update($box, new_scale){
       $box.x_top = $box.x_top_initial * new_scale
       $box.x_len = $box.x_len_initial * new_scale
     }

      var $x_scale_slider = $('<div class="jrac_zoom_slider"><div class="ui-slider-handle"></div></div>')
          .slider({
            value: 694,
            min: 594,
            max: 2000,
            slide: function (event, ui) {
              var new_zoom = $image.start_width / ui.value
              for (let $box of boxes) x_scale_update($box, new_zoom);
              updateBoxes()
            }
          });
      $container.append($x_scale_slider);

      function y_scale_update($box, new_scale){
       $box.y_top = $box.y_top_initial * new_scale
       $box.y_len = $box.y_len_initial * new_scale
     }

      var $y_scale_slider = $('<div class="jrac_zoom_slider"><div class="ui-slider-handle"></div></div>')
          .slider({
            value: 694,
            min: 594,
            max: 2000,
            slide: function (event, ui) {
              var new_zoom = $image.start_width / ui.value
              for (let $box of boxes) y_scale_update($box, new_zoom);
              updateBoxes()
            }
          });
      $container.append($y_scale_slider);

       {% for char in a_chars %}
        var $gotbox = buildABox({{ char.mainchar.x1 }}, {{ char.mainchar.y1 }}, {{  char.mainchar.x2 }}, {{  char.mainchar.y2 }})
        $gotbox.related_chars = $(' \
         {% for related_char in char.relatedChars %} \
            <li> \
            <span>{{  related_char.id }}</span> \
              <img src="{% static related_char.get_image %}" /> \
            </li> \
        {% endfor %} ')
        boxes.add($gotbox)
        $viewport.append($gotbox)
      {% endfor %}
    }


  $(document).ready( iWindow )
  </script>

{% endblock %}
